%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% CSCI 1430 Homework --- document setup
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}[2023-11-01]
\ProvidesClass{csci1430}[2026/01/19 CSC1430 LaTeX Questions v0.2]

\newif\if@csci@export
\DeclareOption{exportexpectedpages}{\@csci@exporttrue}

\DeclareOption*{\PassOptionsToClass{\CurrentOption}{article}}
\ProcessOptions
\LoadClass[11pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{microtype}
\usepackage{times}
\newcommand{\filled}{\ensuremath{\blacksquare}}

\usepackage[a4paper,margin=1.5in]{geometry}
\usepackage{amsmath,amssymb}
\usepackage{xcolor}
\usepackage[colorlinks = true,
            linkcolor = blue,
            urlcolor  = blue]{hyperref}
\usepackage{stackengine,graphicx,trimclip}
\usepackage[most]{tcolorbox}
\usepackage{fancyhdr}
\setlength{\headheight}{14pt}

% Lists and default spacing
\usepackage[shortlabels]{enumitem}
\setlist[itemize]{itemsep=2pt, topsep=2pt, partopsep=2pt, parsep=2pt}
\setlist[enumerate]{itemsep=2pt, topsep=2pt, partopsep=2pt, parsep=2pt}
\setlist[description]{itemsep=2pt, topsep=2pt, partopsep=2pt, parsep=2pt}
% setup for todo lists:
\newlist{todolist}{itemize}{2}
\setlist[todolist]{label=$\square$}

% a great python code format: https://github.com/olivierverdier/python-latex-highlighting
\usepackage{pythonhighlight}

\frenchspacing
\setlength{\parindent}{0cm} % Default is 15pt.
\setlength{\parskip}{0.3cm plus1mm minus1mm}
% Adjust the space before and after the title
%\titlespacing*{\title}{0pt}{-1em}{1em}

% Set new counters for our questions
\newcounter{question}[section]
\newcounter{subquestion}[subsection]
\newcounter{subsubquestion}[subsubsection]

%% Switch to 'LaTeX3' style operations
\ExplSyntaxOn

%
% BOXES: Orange / green boxes environments
%
% Define variables globally to hold question/answer state
\int_new:N \l_question_points_int
\int_new:N \l_answer_height_int
\bool_new:N \l_question_drawbox_bool
\tl_new:N \l_question_points_str
\tl_new:N \l_question_pointpoints_str
% Scratch space for per-page label assembly
\tl_new:N \l_expected_page_label_tl
\bool_new:N \l_expected_page_ok_bool
\tl_new:N \g_expected_total_pages_tl
\int_new:N \g_expected_total_pages_int
% Temporary sequence for expected labels on current page
\seq_new:N \l_expected_page_labels_seq
% Expected labels per page (loaded from expected pages file)
\prop_new:N \g_expected_page_labels_prop
% Expected-page export controls
\bool_new:N \g_export_expected_pages_bool
\if@csci@export
    \bool_gset_true:N \g_export_expected_pages_bool
\fi
\tl_new:N \g_expected_pages_file_tl
\iow_new:N \g_expected_pages_iow
% Persistent point-summary state (stored via .aux between runs)
\seq_new:N \g_prev_question_points_seq
\int_new:N \g_prev_question_points_total_int
\int_new:N \g_prev_question_count_int
% Current-run point-summary state (written out for next run)
\seq_new:N \g_curr_question_points_seq
\int_new:N \g_curr_question_points_total_int
\int_new:N \g_curr_question_count_int
% Variable to store the homework short name
\tl_new:N \g_homework_shortname_tl

\NewDocumentCommand{\HomeworkShortName}{m}
{
    \tl_gset:Nn \g_homework_shortname_tl { #1 }
}

\NewDocumentCommand{\GetHomeworkShortName}{}
{
    \tl_use:N \g_homework_shortname_tl
}

\cs_new_protected:Npn \reset_question_points_prev:
{
    % Clear previous-run totals (reinitialized each compile)
    \seq_gclear:N \g_prev_question_points_seq
    \int_gzero:N \g_prev_question_points_total_int
    \int_gzero:N \g_prev_question_count_int
}

\cs_new_protected:Npn \record_question_points_prev:n #1
{
    % Load points from last run (read from .aux)
    \seq_gput_right:Nn \g_prev_question_points_seq { #1 }
    \int_gadd:Nn \g_prev_question_points_total_int { #1 }
    \int_gincr:N \g_prev_question_count_int
}

\cs_new_protected:Npn \record_question_points_curr:n #1
{
    % Record points from this run (will be written to .aux)
    \seq_gput_right:Nn \g_curr_question_points_seq { #1 }
    \int_gadd:Nn \g_curr_question_points_total_int { #1 }
    \int_gincr:N \g_curr_question_count_int
}

\cs_new_protected:Npn \append_label_to_page_prop:nn #1#2
{
    \prop_get:NnNTF \g_expected_page_labels_prop { #1 } \l_tmpa_tl
    {
        \tl_set:Nx \l_tmpb_tl { \l_tmpa_tl\space and\space #2 }
        \prop_gput:NnV \g_expected_page_labels_prop { #1 } \l_tmpb_tl
    }
    {
        \prop_gput:Nnn \g_expected_page_labels_prop { #1 } { #2 }
    }
}

\cs_new_protected:Npn \set_expected_page_label:n #1
{
    % Build the expected footer label for a page from the fixed map
    \tl_set:Nx \l_tmpb_tl { \int_eval:n { #1 } }
    \prop_get:NVNTF \g_expected_page_labels_prop \l_tmpb_tl \l_tmpa_tl
    {
        \tl_set:Nn \l_expected_page_label_tl { \l_tmpa_tl }
        \bool_set_true:N \l_expected_page_ok_bool
    }
    {
        \tl_set:Nn \l_expected_page_label_tl { [ERROR:\space PAGE\space MISALIGNMENT] }
        \bool_set_false:N \l_expected_page_ok_bool
    }
}

\NewDocumentCommand{\ExpectedPageLabel}{}
{
    \set_expected_page_label:n { \value{page} }
    \textbf{\l_expected_page_label_tl}
}

\NewDocumentCommand{\ExpectedPageFooterText}{}
{
    \set_expected_page_label:n { \value{page} }
    \bool_if:NTF \l_expected_page_ok_bool
    { \textbf{Only}~\textbf{\l_expected_page_label_tl}~\textbf{should~be~on~this~page} }
    { \textbf{\l_expected_page_label_tl} }
}

\NewDocumentCommand{\SetExpectedPageLabel}{mm}
{
    \append_label_to_page_prop:nn { #1 } { #2 }
}

\NewDocumentCommand{\SetExpectedLabelPage}{mm}
{
    \tl_set:Nn \l_tmpa_tl { #1 }
    \tl_remove_once:Nn \l_tmpa_tl { marker: }
    \SetExpectedPageLabel{#2}{\l_tmpa_tl}
}

\cs_new_protected:Npn \register_page_marker:nn #1#2
{
    % Dual purpose:
    % 1. Create a standard LaTeX label (marker:Q1.1) for internal referencing.
    % 2. If exporting, write a command to the expected_pages file associating 
    %    the current physical page number with this logical question label.
    \tl_set:Nx \l_tmpa_tl { marker:#1 }
    \label{\tl_use:N \l_tmpa_tl}

    \bool_if:NT \g_export_expected_pages_bool
    {
        \iow_now:Nx \g_expected_pages_iow
        {
            \exp_not:N \SetExpectedPageLabel
            { \int_eval:n { \value{page} } }
            { \exp_not:N #2 }
        }
    }
}

\NewDocumentCommand{\PlacePageMarker}{mm}
{
    \register_page_marker:nn { #1 } { #2 }
}

\NewDocumentCommand{\TotalPages}{}
{
    \int_eval:n { \csname @abspage@last\endcsname }
}

\NewDocumentCommand{\ExpectedTotalPages}{}
{
    \tl_if_empty:NTF \g_expected_total_pages_tl
    {
        \int_compare:nNnTF { \g_expected_total_pages_int } > { 0 }
        { \int_use:N \g_expected_total_pages_int }
        { \TotalPages }
    }
    { \g_expected_total_pages_tl }
}

\NewDocumentCommand{\SetExpectedTotalPages}{m}
{
    \tl_gset:Nn \g_expected_total_pages_tl { #1 }
}

\cs_new_protected:Npn \compute_expected_total_pages:
{
    \int_gzero:N \g_expected_total_pages_int
    \prop_map_inline:Nn \g_expected_page_labels_prop
    {
        \int_compare:nNnT { ##1 } > { \g_expected_total_pages_int }
        { \int_gset:Nn \g_expected_total_pages_int { ##1 } }
    }
}

\cs_new_protected:Npn \fill_missing_expected_page_labels:
{
    % "Fill-Forward" Strategy:
    % Iterate through pages 2..N. If a page has no assigned label in the property list
    % (meaning no new Question started on it), assume it continues the previous logical question.
    % We copy the label from (current_page - 1) to (current_page).
    \int_step_inline:nnn { 2 } { \g_expected_total_pages_int }
    {
        \prop_if_in:NnF \g_expected_page_labels_prop { ##1 }
        {
            \tl_set:Nx \l_tmpa_tl { \int_eval:n { ##1 - 1 } }
            \prop_get:NVNT \g_expected_page_labels_prop \l_tmpa_tl \l_tmpb_tl
            {
                \prop_gput:NnV \g_expected_page_labels_prop { ##1 } \l_tmpb_tl
            }
        }
    }
}

\NewDocumentCommand{\QuestionPointsSummary}{}
{
    % Render the summary using previous-run data, like a ToC
    \int_compare:nNnTF { \g_prev_question_count_int } > { 0 }
    {
        \int_use:N \g_prev_question_count_int\space questions \space \textbf{[ \seq_use:Nn \g_prev_question_points_seq {~+~} ~=~ \int_use:N \g_prev_question_points_total_int\space points ]}.
    }
    {
        \textbf{Questions total pending. Recompile to update points.}
    }
}

% Questions: Define key-value options handler globally
\keys_define:nn { question }
{
    points   .int_set:N = \l_question_points_int,
    drawbox  .bool_set:N = \l_question_drawbox_bool,
}
% Plus its defaults
\keys_set:nn { question } { points = 0, drawbox = true }

% Answers: Define key-value options handler globally
\keys_define:nn { answer }
{
    height   .int_set:N = \l_answer_height_int,
}
% Plus its defaults
\keys_set:nn { answer } { height = 0 }

\NewDocumentEnvironment{orangebox}{}
{
    \begin{tcolorbox}[colback=orange!5!white,colframe=orange!75!black]
}{
    \end{tcolorbox}
}

% Define the new document environment
\NewDocumentEnvironment{question}{O{}}
{
    % Define local scope to this environment
    \group_begin: 

    % Reset counters
    \setcounter{subquestion}{0}
    \setcounter{subsubquestion}{0}

    \addtocounter{question}{1}

    % Parse parameter key/values
    \keys_set:nn { question } { #1 }

    % Register a marker for expected-page checking
    \register_page_marker:nn { Q\thequestion } { Q\thequestion }

    % Record points for automated summary (use previous run data for display)
    \int_compare:nNnT { \l_question_points_int } > { 0 }
    {
        \record_question_points_curr:n { \l_question_points_int }
        % Persist this question's points to the .aux for next compile
        \iow_now:Nx \@auxout
        {
            \exp_not:N \csname record_question_points_prev:n\exp_not:N \endcsname
            { \int_use:N \l_question_points_int }
        }
    }


    % Define either "point" or "points" string depending on
    % whether the number of points is equal to 1
    \int_compare:nNnTF { \l_question_points_int } = { 1 } 
    { \tl_set:Nn \l_question_pointpoints_str {point} } 
    { \tl_set:Nn \l_question_pointpoints_str {points} }

    % If the number of points is greater than 0, the define a string for the number of points next to the question.
    \int_compare:nNnTF { \l_question_points_int } > { 0 } 
    { \tl_set:Nx \l_question_points_str {~---~[ \int_use:N \l_question_points_int \ \str_use:N \l_question_pointpoints_str ]} }
    { \tl_set:Nx \l_question_points_str {:} }

    \par\medskip\noindent\textbf{
        % Write "Q" then the question number + points string
        Q\thequestion \str_use:N \l_question_points_str
    }
    \bool_if:NTF \l_question_drawbox_bool
    { \begin{orangebox} }
    {\newline}
}
{
    \bool_if:NT \l_question_drawbox_bool
    { \end{orangebox} }

    % End local scope
    \group_end:
}

\NewDocumentEnvironment{subquestion} { O{} }
{    
    % Define local scope to this environment
    \group_begin: 

    % Handle counters
    \setcounter{subsubquestion}{0}
    \addtocounter{subquestion}{1}

    % Parse parameter key/values
    \keys_set:nn { question } { #1 }

    % Register a marker for expected-page checking
    \register_page_marker:nn { Q\thequestion.\thesubquestion } { Q\thequestion.\thesubquestion }


    % Define either "point" or "points" string depending on
    % whether the number of points is equal to 1
    \int_compare:nNnTF { \l_question_points_int } = { 1 } 
    { \str_set:Nn \l_question_pointpoints_str {point} } 
    { \str_set:Nn \l_question_pointpoints_str {points} }

    % If the number of points is greater than 0, the define a string for the number of points next to the question.
    \int_compare:nNnTF { \l_question_points_int } > { 0 } 
    { \tl_set:Nx \l_question_points_str {~---~[ \int_use:N \l_question_points_int \ \str_use:N \l_question_pointpoints_str ]} }
    { \tl_set:Nx \l_question_points_str {:} }

    \par\medskip\noindent\textbf{
        % Write "Q" then the question number
        Q\thequestion.\thesubquestion \str_use:N \l_question_points_str
    }
    \bool_if:NTF \l_question_drawbox_bool
    { \begin{tcolorbox}[colback=orange!5!white,colframe=orange!75!black] }
    {\newline}
}
{
    \bool_if:NT \l_question_drawbox_bool
    { \end{tcolorbox} }

    % End local scope
    \group_end:
}

\NewDocumentEnvironment{subsubquestion} { O{} }
{
    % Define local scope to this environment
    \group_begin: 

    % Handle counters
    \int_compare:nNnT { \thesubquestion } = { 0 }
    { \addtocounter{subquestion}{1} }
    \addtocounter{subsubquestion}{1}

    % Parse parameter key/values
    \keys_set:nn { question } { #1 }

    % Register a marker for expected-page checking
    \register_page_marker:nn { Q\thequestion.\thesubquestion.\thesubsubquestion } { Q\thequestion.\thesubquestion.\thesubsubquestion }


    % Define either "point" or "points" string depending on
    % whether the number of points is equal to 1
    \int_compare:nNnTF { \l_question_points_int } = { 1 } 
    { \str_set:Nn \l_question_pointpoints_str {point} } 
    { \str_set:Nn \l_question_pointpoints_str {points} }

    % If the number of points is greater than 0, the define a string for the number of points next to the question.
    \int_compare:nNnTF { \l_question_points_int } > { 0 } 
    { \tl_set:Nx \l_question_points_str {~---~[ \int_use:N \l_question_points_int \ \str_use:N \l_question_pointpoints_str ]} }
    { \tl_set:Nx \l_question_points_str {:} }

    \par\medskip\noindent\textbf{
        % Write "Q" then the question number
        Q\thequestion.\thesubquestion.\thesubsubquestion \str_use:N \l_question_points_str
    }
    \bool_if:NTF \l_question_drawbox_bool
    { \begin{tcolorbox}[colback=orange!5!white,colframe=orange!75!black] }
    {\newline}
}{
    \bool_if:NT \l_question_drawbox_bool
    { \end{tcolorbox} }

    % End local scope
    \group_end:
}

\NewDocumentEnvironment{answer} { O{} }
{
    \group_begin:
    \keys_set:nn { answer } { #1 }

    % Define the fixed dimensions for clipping
    \def\clip_height { 1.2\l_answer_height_int\baselineskip }
    
    % Set up a temporary box to hold the content
    \setbox0=\hbox\bgroup

    \int_compare:nNnTF { \l_answer_height_int } > { 0 }
    {
        \begin{tcolorbox}[colback=white!5!white,colframe=green!75!black,height=\l_answer_height_int\baselineskip]
    }{
        \begin{tcolorbox}[colback=white!5!white,colframe=green!75!black]
    }
}{
    \end{tcolorbox}

    % Finish the box and clip it to the specified height
    \egroup
    \clipbox{0pt \dimexpr\ht0-\clip_height\relax{} 0pt 0pt}
      { \copy0 }

    \group_end:
}

\NewDocumentEnvironment{answerlist} { O{} }
{
    \group_begin:

    \begin{answer}
    \begin{todolist}[itemsep=0pt]
}{
    \end{todolist}
    \end{answer}

    \group_end:
}


\AtBeginDocument
{
    % Reset previous-run totals, then clear current-run buffers
    \iow_now:Nn \@auxout { \csname reset_question_points_prev:\endcsname }
    \seq_gclear:N \g_curr_question_points_seq
    \int_gzero:N \g_curr_question_points_total_int
    \int_gzero:N \g_curr_question_count_int
}

\AtBeginDocument
{
    % Handle "Expected Pages" logic
    % If [exportexpectedpages] option is set:
    %   1. We are in TA-mode generating the page mapping file.
    %   2. Open the output stream to write the mapping.
    \bool_if:NTF \g_export_expected_pages_bool
    {
        \tl_gset:Nn \g_expected_pages_file_tl { csci1430_expectedpages.tex }
        \iow_open:Nn \g_expected_pages_iow { \g_expected_pages_file_tl }
    }
    % If [exportexpectedpages] is NOT set (Student/Normal mode):
    %   1. Try to load the pre-generated 'csci1430_expectedpages.tex' file.
    %   2. Calculate the total expected pages based on that file.
    %   3. Fill in any gaps in the page labels to ensure footer continuity.
    {
        \InputIfFileExists{csci1430_expectedpages.tex}{}{}
        \compute_expected_total_pages:
        \fill_missing_expected_page_labels:
    }
}

\AtEndDocument
{
    \bool_if:NT \g_export_expected_pages_bool
    { \iow_close:N \g_expected_pages_iow }
}

\ExplSyntaxOff

%
% The document instructions
\NewDocumentCommand{\writeinstructions}{}
{
    \PlacePageMarker{instructions}{instructions}
    \section*{Template Instructions}

    This document is a template with specific answer regions and a fixed number of pages. Given large class sizes and limited TA time, the template helps the course staff to grade efficiently and still focus on the content of your submissions. Please help us in this task:
    
    \begin{itemize}
    \item Make this document anonymous.
    
    \item Questions are in the orange boxes. Provide answers in the green boxes.
    \item Use the footer to check for correct page alignment.

    \item \textbf{Do NOT remove the answer box.}
    \item \textbf{Do NOT change the size of the answer box.}
    \item \textbf{Extra pages are not permitted unless otherwise specified.}
    \item \textbf{Template edits or page misalignment will lead to a 10 point deduction.}
    \end{itemize}

    \section*{Gradescope Submission}
    \begin{itemize}
    \item Compile this document to a PDF and submit it to Gradescope.
    \item Pages will be automatically assigned to the right questions on Gradescope.
    \end{itemize}

    \section*{This Homework}
    \begin{itemize}
        \item \QuestionPointsSummary
        \item Include code, images, and equations where appropriate.
    \end{itemize}
}


\NewDocumentCommand{\writefeedback}{}
{
    \PlacePageMarker{feedback}{feedback}
    \section*{Feedback? (Optional)}
    We appreciate your feedback on how to improve the course. You can provide anonymous feedback through \href{https://forms.gle/Eu5jJbDUmLknAyJV9}{this form} which can be accessed using your Brown account (your identity will not be collected). If you have urgent non-anonymous comments/questions, please email the instructor.
}


\date{}
\author{CSCI 1430}

% Force the title page to use the fancy style defined below
\let\oldmaketitle\maketitle
\renewcommand{\maketitle}{\oldmaketitle\thispagestyle{fancy}}

\pagestyle{fancy}
\fancyhf{}
\lhead{\GetHomeworkShortName}
\rhead{CSCI1430}

\lfoot{\textcolor{red}{\ExpectedPageFooterText}}
\rfoot{\thepage~/ \ExpectedTotalPages}